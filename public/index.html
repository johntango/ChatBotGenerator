<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Popup App Generator</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
      }
      .column {
        flex: 1;
        border: 1px solid #ddd;
        padding: 20px;
      }
      .preview {
        border: 1px solid #000;
        padding: 20px;
        background-color: white;
        color: black;
      }
      .dark-mode {
        background-color: #333;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>Agent Generator</h1>
    <h3>
      <ul>
        <li>1. Create an Assistant in OpenAI</li>
        <li>2. Upload Files to VectorDB and Attach to Assistant</li>
        <li>3. Create App Code for WebPage</li>
      </ul>
    </h3>
    <div class="container">
      <div class="column">
        <form id="generator-form">
          <label
            >Title of App:
            <input type="text" name="title" id="title" required /></label
          ><br /><br />
          <label
            >Assistant Name:
            <input
              type="text"
              name="assistant_name"
              id="assistant_name"
              required /></label
          ><br /><br />
          <label
            >Assistant System Message:
            <input
              type="text"
              name="assistantMessage"
              id="assistantMessage"
              required /></label
          ><br /><br />
          <button id="createAssistant">Create or get Assistant</button
          ><br /><br />
          <label
            >Directory Path for Files Upload:
            <input type="text" name="dir_path" id="dir_path" required /></label
          ><br /><br />
          <label
            >Embed Type:
            <select name="embed_type" id="embed_type">
              <option value="openai">OpenAI</option>
              <option value="local">Local</option>
            </select>
            <button id="uploadFiles">Upload Files to VectorDB</button> </label
          ><br /><br />

          <label
            >Agent System Instructions:
            <textarea
              name="agent_instructions"
              id="agent_instructions"
              required
            ></textarea></label
          ><br /><br />

          <label
            >Initial Message:
            <textarea
              name="initialMessage"
              id="initialMessage"
              rows="4"
              required
            ></textarea></label
          ><br /><br />
          <label
            >Prompt Placeholder:
            <input
              type="text"
              name="promptPlaceholder"
              id="promptPlaceholder"
              rows="4"
              required /></label
          ><br /><br />
          <label
            >Mode:
            <select name="mode" id="mode">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select> </label
          ><br /><br />
          <button id="generate_agent" type="submit">Generate Agent Code</button>
        </form>
      </div>
      <div class="column preview" id="preview">
        <h2 id="preview-title">[Title]</h2>
        <div>
          <strong>System Message:</strong>
          <span id="preview-system">[System Message]</span>
        </div>
        <div>
          <strong>Initial Messages:</strong>
          <ul id="preview-initial-list">
            [Initial Messages]
          </ul>
        </div>
        <div><strong>Prompt:</strong></div>
        <input
          type="text"
          placeholder="[Prompt Placeholder]"
          id="preview-prompt"
        />
        <button>&#8594;</button>
        <div>
          <strong>Response:</strong>
          <div id="preview-response" style="height: 200px; overflow-y: auto">
            [Response]
          </div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        function updatePreview() {
          console.log("updatePreview called");

          // Update title
          document.getElementById("preview-title").innerText =
            document.getElementById("title").value || "[Title]";

          // Update system message
          document.getElementById("preview-system").innerText =
            document.getElementById("agent_instructions").value ||
            "[System Message]";

          // Update initial messages list
          const initialMessages = document
            .getElementById("initialMessage")
            .value.split("\n")
            .map((msg) => msg.trim())
            .filter((msg) => msg);
          const previewInitialList = document.getElementById(
            "preview-initial-list"
          );
          previewInitialList.innerHTML = "";
          initialMessages.forEach((msg) => {
            const li = document.createElement("li");
            li.innerText = msg;
            previewInitialList.appendChild(li);
          });

          // Update prompt placeholder
          document.getElementById("preview-prompt").placeholder =
            document.getElementById("promptPlaceholder").value ||
            "[Prompt Placeholder]";

          // Update mode
          const mode = document.getElementById("mode").value;

          const preview = document.getElementById("preview");
          preview.classList.remove("dark-mode");
          if (mode === "dark") {
            preview.classList.add("dark-mode");
          }
        }

        document
          .querySelectorAll(
            "#generator-form input, #generator-form textarea, #generator-form select"
          )
          .forEach((element) => {
            element.addEventListener("input", updatePreview);
            element.addEventListener("change", updatePreview);
          });

        console.log(
          document.querySelectorAll(
            "#generator-form input, #generator-form textarea, #generator-form select"
          )
        );
      });
      document
        .getElementById("uploadFiles")
        .addEventListener("click", async () => {
          const dirPath = document.getElementById("dir_path").value;
          const embedType = document.getElementById("embed_type").value;

          const response = await fetch("/upload_files", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ dir_path: dirPath, embed_type: embedType }),
          });

          const result = await response.json();
          alert(result.message);
        });

      document
        .getElementById("createAssistant")
        .addEventListener("click", async () => {
          const name = document.getElementById("assistant_name").value;
          const assistantMessage =
            document.getElementById("assistantMessage").value;

          const response = await fetch("/create_or_get_assistant", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, assistantMessage }),
          });

          const result = await response.json();
          alert(result.message);
        });
      document
        .getElementById("generate_agent")
        .addEventListener("click", async () => {
          let title = document.getElementById("preview-title").value;
          let systemMessage = document.getElementById("preview-system").value;
          let initialMessage = document.getElementById(
            "preview-initial-list"
          ).value;
          let promptPlaceholder =
            document.getElementById("preview-prompt").value;
          let mode = document.getElementById("mode").value;

          // get the state of the focus
          console.log("fetching focus");
          let { message, focus } = await fetch("/get_focus", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({}),
          });
          console.log("got foccus");
          // generate agent code
          const response = await fetch("/generate_agent", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              focus,
              title,
              systemMessage,
              initialMessages,
              promptPlaceholder,
              mode,
            }),
          });
          console.log("response from generate_agent", response);
          if (response.ok) {
            const agentCode = await response.text(); // Parse the response as plain text
            console.log("Agent code generated:", agentCode);

            // Optional: Dynamically download the file
            const blob = new Blob([agentCode], {
              type: "application/javascript",
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "popupAgent.js";
            link.click();
          } else {
            console.error("Error generating agent:", await response.text());
          }
        });
    </script>
  </body>
</html>
